<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>

<body>
    <h2>üîπ Chat Room</h2>

    <label>Nh·∫≠p ph√≤ng: </label>
    <input id="roomInput" type="text" placeholder="Nh·∫≠p t√™n ph√≤ng...">
    <button onclick="joinRoom()">Tham gia</button>
    <button onclick="leaveRoom()">R·ªùi ph√≤ng</button>

    <h3>üìú Danh s√°ch ph√≤ng hi·ªán t·∫°i:</h3>
    <ul id="roomList" style="list-style-type: none; padding: 0;"></ul>


    <h3>üí¨ Tin nh·∫Øn trong ph√≤ng: <span id="roomName"></span></h3>
    <div id="messages" style="border: 1px solid #ccc; height: 200px; overflow-y: auto; padding: 10px;"></div>

    <input id="messageInput" type="text" placeholder="Nh·∫≠p tin nh·∫Øn...">
    <button onclick="sendMessage()">G·ª≠i</button>

    <script>
        const socket = io("http://192.168.0.59:3000");
        let currentRoom = "";

        // T·ª± ƒë·ªông g·ª≠i y√™u c·∫ßu ki·ªÉm tra ph√≤ng khi reload
        socket.emit("reload-request");

        socket.on("reload-response", (room) => {
            if (room) {
                currentRoom = room;
                document.getElementById("roomName").innerText = room;
                console.log(`üîÑ ƒê√£ tham gia l·∫°i ph√≤ng: ${room}`);
            }
        });


        // C·∫≠p nh·∫≠t danh s√°ch ph√≤ng
        socket.on("room-list", (rooms) => {
            const roomList = document.getElementById("roomList");
            roomList.innerHTML = "";

            rooms.forEach((room) => {
                const listItem = document.createElement("li");
                listItem.innerHTML = `üè† ${room.name} - üë• ${room.userCount} ng∆∞·ªùi`;
                roomList.appendChild(listItem);
            });
        });


        // Nh·∫≠n ph·∫£n h·ªìi t·ª´ server sau khi g·ª≠i y√™u c·∫ßu tham gia ph√≤ng
        socket.on("join-room-response", (data) => {
            if (data.status === 1) {
                // Tham gia ph√≤ng th√†nh c√¥ng
                currentRoom = document.getElementById("roomInput").value;
                document.getElementById("roomName").innerText = currentRoom;
                // alert(data.message);  // ‚úÖ Th√¥ng b√°o th√†nh c√¥ng
            } else {
                // Tham gia ph√≤ng th·∫•t b·∫°i
                alert(data.message);  // ‚ùå Th√¥ng b√°o l·ªói
            }
        });


        // Nh·∫≠n tin nh·∫Øn chat
        socket.on("chat-message", (data) => {
            const msgContainer = document.getElementById("messages");
            msgContainer.innerHTML += `<p><strong>${data.sender}:</strong> ${data.message}</p>`;
            msgContainer.scrollTop = msgContainer.scrollHeight;
        });

        // Nh·∫≠n th√¥ng b√°o
        socket.on("message", (msg) => {
            const msgContainer = document.getElementById("messages");
            msgContainer.innerHTML += `<p><em>${msg}</em></p>`;
            msgContainer.scrollTop = msgContainer.scrollHeight;
        });

        // C·∫≠p nh·∫≠t danh s√°ch ph√≤ng v√† s·ªë ng∆∞·ªùi
        socket.on("room-list", (rooms) => {
            const roomListContainer = document.getElementById("roomList");
            roomListContainer.innerHTML = "";

            // Hi·ªÉn th·ªã danh s√°ch ph√≤ng v√† s·ªë ng∆∞·ªùi
            rooms.forEach((room) => {
                const listItem = document.createElement("li");
                listItem.innerHTML = `üè† ${room.name} - üë• ${room.userCount} ng∆∞·ªùi`;
                roomListContainer.appendChild(listItem);
            });
        });

    </script>

    <script>
        // H√†m c·∫≠p nh·∫≠t UI danh s√°ch ph√≤ng
        function updateRoomListUI(rooms) {
            const roomListContainer = document.getElementById("roomList");
            roomListContainer.innerHTML = ""; // X√≥a danh s√°ch hi·ªán t·∫°i

            // Hi·ªÉn th·ªã danh s√°ch ph√≤ng m·ªõi
            rooms.forEach((room) => {
                const listItem = document.createElement("li");
                listItem.innerText = room;
                roomListContainer.appendChild(listItem);
            });
        }

        // H√†m r·ªùi ph√≤ng
        function leaveRoom() {
            if (currentRoom) {
                socket.emit("leave-room", currentRoom);
                currentRoom = "";
                document.getElementById("roomName").innerText = "";
                document.getElementById("messages").innerHTML = "";
            }
        }

        // H√†m g·ª≠i tin nh·∫Øn
        function sendMessage() {
            const message = document.getElementById("messageInput").value;
            if (message && currentRoom) {
                socket.emit("chat-message", { room: currentRoom, message });
                document.getElementById("messageInput").value = "";
            }
        }

        // H√†m tham gia ph√≤ng
        function joinRoom() {
            const room = document.getElementById("roomInput").value;
            if (room) {
                socket.emit("join-room", room);
            }
        }


    </script>
</body>

</html>